name: Deploy Productos to EKS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile.prod'
      - '.github/workflows/deploy.yml'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: microservicios/productos
  EKS_CLUSTER_NAME: microservicios-eks-cluster
  DEPLOYMENT_NAME: productos
  NAMESPACE: microservicios

jobs:
  test-build-deploy:
    name: Test, Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # 1. CHECKOUT CÃ“DIGO
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      # ==========================================
      # 2. EJECUTAR TESTS
      # ==========================================
      - name: ğŸ§ª Run Maven Tests
        run: |
          echo "ğŸ§ª Ejecutando tests con Maven..."
          docker run --rm -v $(pwd):/app -w /app \
            maven:3.9.5-eclipse-temurin-21 mvn test
      
      - name: âœ… Tests passed
        if: success()
        run: echo "âœ… Todos los tests pasaron correctamente"
      
      - name: âŒ Tests failed
        if: failure()
        run: |
          echo "âŒ Los tests fallaron. Deployment cancelado."
          exit 1
      
      # ==========================================
      # 3. CONFIGURAR AWS
      # ==========================================
      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # ==========================================
      # 4. LOGIN A ECR
      # ==========================================
      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      # ==========================================
      # 5. BUILD & PUSH DOCKER IMAGE
      # ==========================================
      - name: ğŸ³ Build, tag, and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ—ï¸ Construyendo imagen Docker..."
          docker build -f Dockerfile.prod -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "ğŸ“¤ Subiendo imagen a ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "ğŸ·ï¸ Taggeando como 'latest'..."
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Imagen subida: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
      
      # ==========================================
      # 6. INSTALAR KUBECTL
      # ==========================================
      - name: ğŸ”§ Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      # ==========================================
      # 7. ACTUALIZAR KUBECONFIG
      # ==========================================
      - name: â˜¸ï¸ Update kubeconfig
        run: |
          echo "ğŸ”„ Actualizando kubeconfig para EKS..."
          aws eks update-kubeconfig \
            --name $EKS_CLUSTER_NAME \
            --region $AWS_REGION
          
          echo "âœ… Kubeconfig actualizado"
          kubectl get nodes
      
      # ==========================================
      # 8. DEPLOY A EKS
      # ==========================================
      - name: ğŸš€ Deploy to EKS
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸš€ Actualizando deployment en EKS..."
          kubectl set image deployment/$DEPLOYMENT_NAME \
            productos=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -n $NAMESPACE
          
          echo "â³ Esperando rollout..."
          kubectl rollout status deployment/$DEPLOYMENT_NAME \
            -n $NAMESPACE \
            --timeout=5m
          
          echo "âœ… Deployment completado exitosamente"
      
      # ==========================================
      # 9. VERIFICAR DEPLOYMENT
      # ==========================================
      - name: ğŸ” Verify deployment
        run: |
          echo "ğŸ“Š Estado de los pods:"
          kubectl get pods -n $NAMESPACE -l app=productos
          
          echo ""
          echo "ğŸ“‹ InformaciÃ³n del deployment:"
          kubectl describe deployment $DEPLOYMENT_NAME -n $NAMESPACE | grep -A 5 "Replicas:"
          
          echo ""
          echo "âœ… VerificaciÃ³n completada"
      
      # ==========================================
      # 10. NOTIFICACIÃ“N DE Ã‰XITO
      # ==========================================
      - name: ğŸ‰ Deployment successful
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT EXITOSO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Imagen: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"